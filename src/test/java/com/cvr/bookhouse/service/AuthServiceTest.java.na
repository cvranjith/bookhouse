package com.cvr.bookhouse.service;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertTrue;

import java.util.List;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import com.cvr.bookhouse.core.Msg;
import com.cvr.bookhouse.model.Session;

public class AuthServiceTest {

    private Session session;
    private UserService userService;
    private AuthService auth;

    @BeforeEach
    void setup() {
        session = new Session();
        userService = new UserService();
        auth = new AuthService(session, userService);
    }

    @Test
    void testFirstLogin() {
        var r = auth.login("cv");
        assertTrue(r.ok());
        assertEquals("cv", session.getUserId());
        List<Msg> msgs = r.messages();
        assertEquals(2, msgs.size());
        assertEquals("login.success", msgs.get(0).code());
        assertEquals("login.first", msgs.get(1).code());
    }

    @Test
    void testReLogin() {
        assertTrue(auth.login("cv").ok());
        var r = auth.login("cv");
        assertFalse(r.ok());
        //assertTrue(r.msg().contains("already logged in"));
        assertEquals("cv", session.getUserId());
        List<Msg> msgs = r.messages();
        assertEquals(1, msgs.size());
        assertEquals("already.loggedin", msgs.get(0).code());
    }
    
    @Test
    void testReLoginNewUser() {
        assertTrue(auth.login("cv").ok());
        var r = auth.login("cv2");
        assertTrue(r.ok());
        //assertTrue(r.msg().contains("Welcome, cv2"));
        assertEquals("cv2", session.getUserId());
    }

    @Test
    void testReLoginSameUser() {
        assertTrue(auth.login("cv").ok());
        assertTrue(auth.login("cv2").ok());
        var r = auth.login("cv");
        assertTrue(r.ok());
        //assertTrue(r.msg().contains("Your last login was at"));
        List<Msg> msgs = r.messages();
        assertEquals(2, msgs.size());
        assertEquals("login.success", msgs.get(0).code());
        assertEquals("login.last", msgs.get(1).code());
    }

    @Test
    void testLogout() {
        auth.login("cv");
        assertEquals("cv", session.getUserId());
        var r = auth.logout();
        assertTrue(r.ok());
        assertEquals("", session.getUserId());
        List<Msg> msgs = r.messages();
        assertEquals(1, msgs.size());
        assertEquals("logged.out", msgs.get(0).code());
    }

    @Test
    void testInvalidLogout() {
        var r = auth.logout();
        assertFalse(r.ok());
        assertEquals("", session.getUserId());
    }
}
